<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RootSource AI - Your Expert AI Assistant for Farming & Agriculture</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="RootSource AI is a sophisticated, multilingual agricultural assistant powered by AI. Get expert farming advice, crop management tips, and agricultural insights in 40+ languages with voice interface support.">
    <meta name="keywords" content="agriculture AI, farming assistant, crop management, agricultural technology, smart farming, precision agriculture, AI chatbot, farming advice">
    <meta name="author" content="Team BlueDot">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://rafi-uzzaman.github.io/RootSource/">
    <meta property="og:title" content="üå± RootSource AI - Revolutionizing Agriculture Through AI">
    <meta property="og:description" content="Your digital farming companion combining cutting-edge AI with agricultural expertise. Get instant expert advice, multilingual support, and voice-first experience for modern farmers.">
    <meta property="og:image" content="https://rafi-uzzaman.github.io/RootSource/assets/social-preview.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="RootSource AI - AI-Powered Agricultural Assistant">
    <meta property="og:site_name" content="RootSource AI">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://rafi-uzzaman.github.io/RootSource/">
    <meta name="twitter:title" content="üå± RootSource AI - AI Agricultural Assistant">
    <meta name="twitter:description" content="Revolutionizing farming with AI intelligence. Get expert agricultural advice in 40+ languages with advanced voice interface. Built for modern farmers worldwide.">
    <meta name="twitter:image" content="https://rafi-uzzaman.github.io/RootSource/assets/social-preview.png">
    <meta name="twitter:image:alt" content="RootSource AI Dashboard showing AI-powered farming assistant interface">
    <meta name="twitter:creator" content="@rootsourceai">
    <meta name="twitter:site" content="@rootsourceai">
    
    <!-- Additional Meta Tags -->
    <meta name="theme-color" content="#2ecc71">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="RootSource AI">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="assets/logo.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="assets/css/google-font.css">
    <link rel="stylesheet" href="assets/css/style.css">
    
</head>
<body>
    <!-- About Modal -->
    <div id="aboutModal" class="custom-alert-modal">
        <div class="custom-alert-content">
            <button id="aboutModalClose" class="custom-alert-close">&times;</button>
            <div class="about-logo">
                <img src="assets/logo.png" alt="RootSource AI Logo">
            </div>
            <p class="about-description">
                RootSource AI is a sophisticated, multilingual agricultural assistant designed to provide farmers, researchers, and enthusiasts with expert-level advice and real-time information. By integrating a powerful AI engine with a multi-source research system and a seamless voice interface, RootSource AI delivers accurate, context-aware answers to all your farming questions.
            </p>
            <div class="about-features">
                <h3>Key Features</h3>
                <ul>
                    <li><span class="feature-icon">ü§ñ</span> Advanced AI Engine</li>
                    <li><span class="feature-icon">üîç</span> Multi-Source Research</li>
                    <li><span class="feature-icon">üåê</span> Global Language Support</li>
                    <li><span class="feature-icon">üéôÔ∏è</span> Hands-Free Voice Interface</li>
                </ul>
            </div>
            <div class="about-footer">
                <p>Developed with ‚ù§Ô∏è by Team BlueDot</p>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlert" class="custom-alert-modal">
        <div class="custom-alert-content">
            <button id="customAlertClose" class="custom-alert-close">&times;</button>
            <div class="custom-alert-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.74c1.154 2-.762 4.5-3.121 4.5H5.167c-2.36 0-4.275-2.5-3.12-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
                </svg>
            </div>
            <h3 class="custom-alert-title">Voice Unavailable</h3>
            <p id="customAlertMessage" class="custom-alert-message"></p>
        </div>
    </div>
    
    <div class="overlay"></div>
    
    <!-- Voice Response Indicator -->
    <div id="voiceIndicator" class="voice-indicator">
        <svg class="voice-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8.25 4.5a3.75 3.75 0 1 1 7.5 0v4a3.75 3.75 0 1 1-7.5 0v-4Z" />
            <path d="M6 10.5a.75.75 0 0 1 .75.75v1.5a5.25 5.25 0 1 0 10.5 0v-1.5a.75.75 0 0 1 1.5 0v1.5a6.751 6.751 0 0 1-6 6.709v2.291h3a.75.75 0 0 1 0 1.5h-7.5a.75.75 0 0 1 0-1.5h3v-2.291A6.751 6.751 0 0 1 5.25 12.75v-1.5A.75.75 0 0 1 6 10.5Z" />
        </svg>
        <span class="voice-text">Reading response...</span>
        <button id="stopVoiceBtn" class="stop-voice-btn" title="Stop voice">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M5.25 7.5A2.25 2.25 0 0 1 7.5 5.25h9a2.25 2.25 0 0 1 2.25 2.25v9a2.25 2.25 0 0 1-2.25 2.25h-9a2.25 2.25 0 0 1-2.25-2.25v-9Z" />
            </svg>
        </button>
    </div>
    
    <div class="container">
        <div class="logo">
            <img src="assets/logo.png" alt="RootSource AI Logo">
            <h1>AI</h1>
        </div>
        <div class="tagline">Ask your farming-related questions in any language, and get accurate answers!</div>
        <div class="developer-info" style="font-style: oblique; font-family: monospace;color: gold; text-decoration: underline;font-weight: 400;">Developed by: Team "BlueDot"</div>
        <div class="about-link-container">
            <a href="#" id="aboutLink">About RootSource AI</a>
        </div>
        <div class="chat-area">


            
            <!-- <div class="input-box">
                <div class="message">
                    <p>

                        what is rice
                    </div>
                    </p>
                <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 11.25a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" /><path fill-rule="evenodd" d="M2.513 14.077c.427 1.344 1.144 2.524 2.158 3.493.593.565 1.25.998 1.942 1.353A9.998 9.998 0 0 0 12 22.5c2.686 0 5.224-.809 7.387-2.378a7.522 7.522 0 0 1-.954-1.076l-.41-.41a5.158 5.158 0 0 0-1.077-.92c-.657-.362-1.378-.588-2.127-.674a18.284 18.284 0 0 0-1.923-.205 18.423 18.423 0 0 0-3.328.096c-.76.088-1.503.313-2.164.675a5.21 5.21 0 0 0-1.085.92l-.41.41c-.244.246-.465.48-.654.708a10.045 10.045 0 0 0-.847.962 10.012 10.012 0 0 0-.962.847l-.025.027a3.024 3.024 0 0 1-.724.593c-.633.364-1.348.59-2.091.674-.63.074-1.295.06-1.92-.046-.226-.038-.45-.074-.674-.11ZM3.75 7.5c0-.621.504-1.125 1.125-1.125h13.5c.621 0 1.125.504 1.125 1.125v6.75a9.996 9.996 0 0 0-2.07-.363 18.204 18.204 0 0 1-3.328-.096 18.416 18.416 0 0 1-1.923-.205c-.749-.086-1.47-.312-2.127-.674a5.158 5.158 0 0 0-1.077-.92l-.41-.41a7.522 7.522 0 0 1-.954-1.076C5.224 15.06 4.417 12.52 4.417 10.5a7.5 7.5 0 0 1-1.125-3V7.5Zm0 0c-.621 0-1.125.504-1.125 1.125v.75c0 4.142 3.358 7.5 7.5 7.5s7.5-3.358 7.5-7.5V8.625c0-.621-.504-1.125-1.125-1.125H3.75Z" clip-rule="evenodd" /></svg>
                </div>
            </div>
            <div class="chat-message">
                <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.061-1.061l-1.59 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM12 1.5a.75.75 0 0 0-.75.75V3a.75.75 0 0 0 1.5 0V2.25a.75.75 0 0 0-.75-.75ZM6.166 18.894a.75.75 0 0 0 1.061 1.06l1.59-1.59a.75.75 0 0 0-1.06-1.061l-1.591 1.59ZM18.894 17.832a.75.75 0 0 1 0 1.062l-1.59 1.59a.75.75 0 0 1-1.061-1.06l1.59-1.59a.75.75 0 0 1 1.062 0ZM12 22.5a.75.75 0 0 0 .75-.75v-2.25a.75.75 0 0 0-1.5 0v2.25c0 .414.336.75.75.75ZM22.5 12a.75.75 0 0 0-.75-.75h-2.25a.75.75 0 0 0 0 1.5h2.25c.414 0 .75-.336.75-.75ZM1.5 12a.75.75 0 0 0 .75.75h2.25a.75.75 0 0 0 0-1.5H2.25c-.414 0-.75.336-.75.75ZM17.832 6.166a.75.75 0 0 1 1.062 0l1.59 1.59a.75.75 0 1 1-1.06 1.061l-1.59-1.59a.75.75 0 0 1 0-1.061ZM6.166 5.105a.75.75 0 0 1 1.06-1.06l1.59 1.59a.75.75 0 0 1-1.06 1.061l-1.591-1.59Z" /></svg>
                </div>
                <div class="message-content">
                    <div class="chat-header">
                        <span class="label detected">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.513 14.077c.427 1.344 1.144 2.524 2.158 3.493.593.565 1.25.998 1.942 1.353A9.998 9.998 0 0 0 12 22.5c2.686 0 5.224-.809 7.387-2.378a7.522 7.522 0 0 1-.954-1.076l-.41-.41a5.158 5.158 0 0 0-1.077-.92c-.657-.362-1.378-.588-2.127-.674a18.284 18.284 0 0 0-1.923-.205 18.423 18.423 0 0 0-3.328.096c-.76.088-1.503.313-2.164.675a5.21 5.21 0 0 0-1.085.92l-.41.41c-.244.246-.465.48-.654.708a10.045 10.045 0 0 0-.847.962 10.012 10.012 0 0 0-.962.847l-.025.027a3.024 3.024 0 0 1-.724.593c-.633.364-1.348.59-2.091.674-.63.074-1.295.06-1.92-.046-.226-.038-.45-.074-.674-.11ZM3.75 7.5c0-.621.504-1.125 1.125-1.125h13.5c.621 0 1.125.504 1.125 1.125v6.75a9.996 9.996 0 0 0-2.07-.363 18.204 18.204 0 0 1-3.328-.096 18.416 18.416 0 0 1-1.923-.205c-.749-.086-1.47-.312-2.127-.674a5.158 5.158 0 0 0-1.077-.92l-.41-.41a7.522 7.522 0 0 1-.954-1.076C5.224 15.06 4.417 12.52 4.417 10.5a7.5 7.5 0 0 1-1.125-3V7.5Zm0 0c-.621 0-1.125.504-1.125 1.125v.75c0 4.142 3.358 7.5 7.5 7.5s7.5-3.358 7.5-7.5V8.625c0-.621-.504-1.125-1.125-1.125H3.75Z" clip-rule="evenodd" /></svg>
                             Detected Language: EN
                        </span>
                        <span class="label translated">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 16.5 0 8.25 8.25 0 0 1-16.5 0Zm18.528 2.222a.75.75 0 0 0-1.06 1.06l1.22 1.22a.75.75 0 0 0 1.06-1.06l-1.22-1.22Z" clip-rule="evenodd" /><path d="M11.25 17.25a.75.75 0 0 0-.75.75v2.25a.75.75 0 0 0 1.5 0V18a.75.75 0 0 0-.75-.75Z" /></svg>
                             
                             Translated Query: 

                    Rice is the edible seed (grain) of the grass species, Oryza sativa (Asian rice) and, to a lesser extent, Oryza glaberrima (African rice). It is cultivated worldwide, often in flooded paddies or dry fields, and serves as a staple food for more than half of the global population, providing a major source of carbohydrates, calories, and some protein. After harvesting, the rice grain is milled to remove the husk (producing brown rice) and sometimes the bran layer (producing white rice), and it is used in a wide variety of culinary dishes.

                        </span>
                    </div>
                    <div class="chat-bubble">
                        <p style="text-align: justify;"><strong>Rice</strong> is the edible seed (grain) of the grass species, <i>Oryza sativa</i> (Asian rice) and, to a lesser extent, <i>Oryza glaberrima</i> (African rice). It is cultivated worldwide, often in flooded paddies or dry fields, and serves as a staple food for more than half of the global population, providing a major source of carbohydrates, calories, and some protein. After harvesting, the rice grain is milled to remove the husk (producing brown rice) and sometimes the bran layer (producing white rice), and it is used in a wide variety of culinary dishes.</p>
                    </div>
                </div>
            </div> -->

            <!-- <div class="chat-message fourdot">
                <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.061-1.061l-1.59 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM12 1.5a.75.75 0 0 0-.75.75V3a.75.75 0 0 0 1.5 0V2.25a.75.75 0 0 0-.75-.75ZM6.166 18.894a.75.75 0 0 0 1.061 1.06l1.59-1.59a.75.75 0 0 0-1.06-1.061l-1.591 1.59ZM18.894 17.832a.75.75 0 0 1 0 1.062l-1.59 1.59a.75.75 0 0 1-1.061-1.06l1.59-1.59a.75.75 0 0 1 1.062 0ZM12 22.5a.75.75 0 0 0 .75-.75v-2.25a.75.75 0 0 0-1.5 0v2.25c0 .414.336.75.75.75ZM22.5 12a.75.75 0 0 0-.75-.75h-2.25a.75.75 0 0 0 0 1.5h2.25c.414 0 .75-.336.75-.75ZM1.5 12a.75.75 0 0 0 .75.75h2.25a.75.75 0 0 0 0-1.5H2.25c-.414 0-.75.336-.75.75ZM17.832 6.166a.75.75 0 0 1 1.062 0l1.59 1.59a.75.75 0 1 1-1.06 1.061l-1.59-1.59a.75.75 0 0 1 0-1.061ZM6.166 5.105a.75.75 0 0 1 1.06-1.06l1.59 1.59a.75.75 0 0 1-1.06 1.061l-1.591-1.59Z" /></svg>
                </div>
                <div class="message-content">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div> -->





        </div>
    </div>
    <div class="main-input-container">
        <!-- Location & NASA Data Indicator -->
        <div class="location-status-container">
            <span id="location-indicator" class="location-indicator global-mode" title="Detecting location for personalized agricultural advice...">
                üåç Detecting location...
            </span>
        </div>
        
        <div class="input-box">
            <input type="text" placeholder="Ask your farming-related question here (in any language)..." id="prompt">
            <button id="sendBtn">
                <div style="width:40px">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.981.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.405Z" /></svg>
                </div>
            </button>
        </div>

        <button class="mic-icon commonBtn" id="voice_search">
            <div style="width: 40px;">

                <i class="material-icons">mic</i>
            </div>
            <span>Ask with your voice</span>
      </button>
    </div>


    <div id="microphone" class="">
    <div class="recoder">
      <div class="close"><span></span></div>
      <select name="lang" id="lang">
        <option value="en-US" selected>English - US</option>
        <option value="bn-BD">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
        <option value="hi-IN">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
        <option value="ur-PK">ÿßÿ±ÿØŸà</option>
        <option value="fr-FR">French - FR</option>
        <option value="pt-PT">Portugu√™s - PT</option>
      </select>
      <p id="recoredText"></p>
      <button id="speakBtn"><i class="material-icons">mic</i></button>
    </div>
  </div>


  <script src="assets/js/jquery.js"></script>
    <!-- Optional runtime config: define window.ROOTSOURCE_API_BASE for GitHub Pages -->
    <script src="assets/js/config.js"></script>
  <script src="assets/js/script.js"></script>


<script>
$(document).ready(function () {
    let flag = 1;

    // NASA Integration Variables
    let userLocation = null;
    let nasaDataEnabled = false;
    let locationDetectionAttempted = false;

    // Basic initialization test
    console.log('‚úÖ Document ready function loaded');
    
    // Test basic functionality without NASA integration for now
    try {
        console.log('‚úÖ jQuery version:', $.fn.jquery);
        
        // Test if page elements are accessible
        if ($('#prompt').length) {
            console.log('‚úÖ Input element found');
        } else {
            console.log('‚ùå Input element not found');
        }
        
        console.log('‚úÖ RootSource AI initialization complete');
        
        // Initialize NASA location detection
        setTimeout(() => {
            detectUserLocation().then(() => {
                console.log('üöÄ NASA-enhanced RootSource AI ready!');
            }).catch(err => {
                console.log('‚ö†Ô∏è Using global mode:', err.message);
                updateLocationIndicator(null);
            });
        }, 1000);
        
        // Update location indicator to show global mode
        try {
            const indicator = document.getElementById('location-indicator');
            if (indicator) {
                indicator.textContent = 'üåç Global Mode';
                indicator.className = 'location-indicator global-mode';
                indicator.title = 'Global mode - Basic agricultural advice available';
                console.log('‚úÖ Location indicator updated to global mode');
            }
        } catch (e) {
            console.log('‚ö†Ô∏è Error updating location indicator:', e);
        }
        
    } catch (e) {
        console.log('‚ùå Error during basic initialization:', e);
    }

    // NASA Location Detection Functions
    async function detectUserLocation() {
        if (locationDetectionAttempted) return userLocation;
        locationDetectionAttempted = true;
        
        try {
            // Try browser geolocation first (most accurate)
            if (navigator.geolocation) {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            // First, get the coordinates
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            
                            // Get address details from our backend API (which has better geolocation)
                            try {
                                // Use our backend to get location details (it may have better IP-based data)
                                const detailsResponse = await fetch('/api/location/detect');
                                
                                if (detailsResponse.ok) {
                                    const detailsData = await detailsResponse.json();
                                    if (detailsData.success && detailsData.location) {
                                        // Use backend's address data but keep precise GPS coordinates
                                        const backendLocation = detailsData.location;
                                        userLocation = {
                                            latitude: lat,  // Use precise GPS coordinates
                                            longitude: lon, // Use precise GPS coordinates
                                            accuracy: position.coords.accuracy,
                                            source: 'browser-enhanced',
                                            city: backendLocation.city || 'Detected Location',
                                            country: backendLocation.country || 'Unknown Country',
                                            region: backendLocation.region || 'Unknown Region',
                                            timezone: backendLocation.timezone || 'UTC'
                                        };
                                        
                                        console.log('üìç GPS Coordinates:', `${lat.toFixed(4)}, ${lon.toFixed(4)}`);
                                        console.log('üèôÔ∏è Address (from backend):', `${userLocation.city}, ${userLocation.country}`);
                                    } else {
                                        throw new Error('Backend location data unavailable');
                                    }
                                } else {
                                    throw new Error(`Backend API error: ${detailsResponse.status}`);
                                }
                                
                            } catch (e) {
                                // Fallback: use coordinates as display names
                                userLocation = {
                                    latitude: lat,
                                    longitude: lon,
                                    accuracy: position.coords.accuracy,
                                    source: 'browser-fallback',
                                    city: 'GPS Location',
                                    country: `${lat.toFixed(3)}¬∞N, ${lon.toFixed(3)}¬∞E`,
                                    region: 'Precise Coordinates',
                                    timezone: 'UTC'
                                };
                                console.log('‚ö†Ô∏è Using coordinate display fallback:', e.message);
                            }
                            
                            // Get NASA context with the precise coordinates
                            try {
                                const response = await fetch('/api/location/context', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        latitude: userLocation.latitude,
                                        longitude: userLocation.longitude
                                    })
                                });
                                
                                if (response.ok) {
                                    const contextData = await response.json();
                                    userLocation.context = contextData.context;
                                    nasaDataEnabled = true;
                                    updateLocationIndicator(userLocation);
                                    console.log('üõ∞Ô∏è NASA agricultural data loaded for precise location');
                                }
                            } catch (e) {
                                console.log('‚ö†Ô∏è NASA context unavailable:', e.message);
                                updateLocationIndicator(userLocation);
                            }
                            
                            resolve(userLocation);
                        },
                        async () => {
                            // Fallback to IP-based detection
                            await detectLocationByIP();
                            resolve(userLocation);
                        },
                        { timeout: 10000 }
                    );
                });
            } else {
                // Browser doesn't support geolocation
                await detectLocationByIP();
            }
        } catch (error) {
            console.log('Location detection failed:', error);
            await detectLocationByIP();
        }
        
        return userLocation;
    }

    async function detectLocationByIP() {
        try {
            const response = await fetch('/api/location/detect');
            if (response.ok) {
                const data = await response.json();
                if (data.success || data.fallback) {
                    userLocation = {
                        ...data.location,
                        source: data.fallback ? 'fallback' : 'ip'
                    };
                    
                    // Get NASA context for IP-detected location
                    try {
                        const contextResponse = await fetch('/api/location/context', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                latitude: userLocation.latitude,
                                longitude: userLocation.longitude
                            })
                        });
                        
                        if (contextResponse.ok) {
                            const contextData = await contextResponse.json();
                            userLocation.context = contextData.context;
                            nasaDataEnabled = true;
                            updateLocationIndicator(userLocation);
                            console.log('üõ∞Ô∏è NASA data loaded via IP geolocation');
                        }
                    } catch (e) {
                        console.log('‚ö†Ô∏è NASA context unavailable:', e.message);
                    }
                }
            }
        } catch (error) {
            console.log('IP-based location detection failed:', error);
        }
    }

    function updateLocationIndicator(location) {
        const indicator = document.getElementById('location-indicator');
        if (indicator) {
            let locationText = '';
            let statusClass = '';
            
            if (location && nasaDataEnabled) {
                // Show detailed location for NASA mode
                const cityName = location.city !== 'Unknown' ? location.city : 'Detected Location';
                const countryName = location.country !== 'Unknown' ? location.country : 
                    `${location.latitude.toFixed(2)}¬∞, ${location.longitude.toFixed(2)}¬∞`;
                locationText = `üìç ${cityName}, ${countryName} üõ∞Ô∏è`;
                statusClass = 'nasa-enabled';
                indicator.title = `NASA satellite data active for ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)} - Enhanced agricultural recommendations`;
            } else if (location) {
                // Show location for basic mode
                const cityName = location.city !== 'Unknown' ? location.city : 'Your Location';
                const countryName = location.country !== 'Unknown' ? location.country : 
                    `${location.latitude.toFixed(2)}¬∞, ${location.longitude.toFixed(2)}¬∞`;
                locationText = `üìç ${cityName}, ${countryName}`;
                statusClass = 'location-only';
                indicator.title = `Location detected: ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)} - Location-aware agricultural advice`;
            } else {
                locationText = 'üåç Global Mode';
                statusClass = 'global-mode';
                indicator.title = 'Global mode - General agricultural advice';
            }
            
            indicator.textContent = locationText;
            indicator.className = `location-indicator ${statusClass}`;
        }
    }

    // Utility Functions
    function getPromptText() {
        return $('#prompt').val().trim();
    }

    function clearPrompt() {
        $('#prompt').val('');
    }

    function setButtonsDisabled(disabled = true) {
        $('#sendBtn').prop('disabled', disabled);
        $('#voice_search').prop('disabled', disabled);
    }

    function appendUserMessage(text) {
        $(".chat-area").append(`
            <div class="input-box">
                <div class="message"><p>${text}</p></div>
                <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 11.25a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" /><path fill-rule="evenodd" d="M2.513 14.077c.427 1.344 1.144 2.524 2.158 3.493.593.565 1.25.998 1.942 1.353A9.998 9.998 0 0 0 12 22.5c2.686 0 5.224-.809 7.387-2.378a7.522 7.522 0 0 1-.954-1.076l-.41-.41a5.158 5.158 0 0 0-1.077-.92c-.657-.362-1.378-.588-2.127-.674a18.284 18.284 0 0 0-1.923-.205 18.423 18.423 0 0 0-3.328.096c-.76.088-1.503.313-2.164.675a5.21 5.21 0 0 0-1.085.92l-.41.41c-.244.246-.465.48-.654.708a10.045 10.045 0 0 0-.847.962 10.012 10.012 0 0 0-.962.847l-.025.027a3.024 3.024 0 0 1-.724.593c-.633.364-1.348.59-2.091.674-.63.074-1.295.06-1.92-.046-.226-.038-.45-.074-.674-.11ZM3.75 7.5c0-.621.504-1.125 1.125-1.125h13.5c.621 0 1.125.504 1.125 1.125v6.75a9.996 9.996 0 0 0-2.07-.363 18.204 18.204 0 0 1-3.328-.096 18.416 18.416 0 0 1-1.923-.205c-.749-.086-1.47-.312-2.127-.674a5.158 5.158 0 0 0-1.077-.92l-.41-.41a7.522 7.522 0 0 1-.954-1.076C5.224 15.06 4.417 12.52 4.417 10.5a7.5 7.5 0 0 1-1.125-3V7.5Zm0 0c-.621 0-1.125.504-1.125 1.125v.75c0 4.142 3.358 7.5 7.5 7.5s7.5-3.358 7.5-7.5V8.625c0-.621-.504-1.125-1.125-1.125H3.75Z" clip-rule="evenodd" /></svg>

                </div>
            </div>
        `);
    }

    // Since backend now returns formatted HTML, just return it as-is
    function formatTextToHTML(text) {
        console.log('Received pre-formatted HTML:', text);
        return text || '';
    }

    function appendBotMessage(reply, detectedLang = "EN", translatedQuery = "") {
        removeDelayAnimation();

        $(".chat-area").append(`
            <div class="chat-message">
                <div class="icon-wrapper">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.061-1.061l-1.59 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM12 1.5a.75.75 0 0 0-.75.75V3a.75.75 0 0 0 1.5 0V2.25a.75.75 0 0 0-.75-.75ZM6.166 18.894a.75.75 0 0 0 1.061 1.06l1.59-1.59a.75.75 0 0 0-1.06-1.061l-1.591 1.59ZM18.894 17.832a.75.75 0 0 1 0 1.062l-1.59 1.59a.75.75 0 0 1-1.061-1.06l1.59-1.59a.75.75 0 0 1 1.062 0ZM12 22.5a.75.75 0 0 0 .75-.75v-2.25a.75.75 0 0 0-1.5 0v2.25c0 .414.336.75.75.75ZM22.5 12a.75.75 0 0 0-.75-.75h-2.25a.75.75 0 0 0 0 1.5h2.25c.414 0 .75-.336.75-.75ZM1.5 12a.75.75 0 0 0 .75.75h2.25a.75.75 0 0 0 0-1.5H2.25c-.414 0-.75.336-.75.75ZM17.832 6.166a.75.75 0 0 1 1.062 0l1.59 1.59a.75.75 0 1 1-1.06 1.061l-1.59-1.59a.75.75 0 0 1 0-1.061ZM6.166 5.105a.75.75 0 0 1 1.06-1.06l1.59 1.59a.75.75 0 0 1-1.06 1.061l-1.591-1.59Z" /></svg>

                </div>
                <div class="message-content">
                    <div class="chat-header">
                        <span class="label detected">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.513 14.077c.427 1.344 1.144 2.524 2.158 3.493.593.565 1.25.998 1.942 1.353A9.998 9.998 0 0 0 12 22.5c2.686 0 5.224-.809 7.387-2.378a7.522 7.522 0 0 1-.954-1.076l-.41-.41a5.158 5.158 0 0 0-1.077-.92c-.657-.362-1.378-.588-2.127-.674a18.284 18.284 0 0 0-1.923-.205 18.423 18.423 0 0 0-3.328.096c-.76.088-1.503.313-2.164.675a5.21 5.21 0 0 0-1.085.92l-.41.41c-.244.246-.465.48-.654.708a10.045 10.045 0 0 0-.847.962 10.012 10.012 0 0 0-.962.847l-.025.027a3.024 3.024 0 0 1-.724.593c-.633.364-1.348.59-2.091.674-.63.074-1.295.06-1.92-.046-.226-.038-.45-.074-.674-.11ZM3.75 7.5c0-.621.504-1.125 1.125-1.125h13.5c.621 0 1.125.504 1.125 1.125v6.75a9.996 9.996 0 0 0-2.07-.363 18.204 18.204 0 0 1-3.328-.096 18.416 18.416 0 0 1-1.923-.205c-.749-.086-1.47-.312-2.127-.674a5.158 5.158 0 0 0-1.077-.92l-.41-.41a7.522 7.522 0 0 1-.954-1.076C5.224 15.06 4.417 12.52 4.417 10.5a7.5 7.5 0 0 1-1.125-3V7.5Zm0 0c-.621 0-1.125.504-1.125 1.125v.75c0 4.142 3.358 7.5 7.5 7.5s7.5-3.358 7.5-7.5V8.625c0-.621-.504-1.125-1.125-1.125H3.75Z" clip-rule="evenodd" /></svg>
                            Detected Language: ${detectedLang}
                            </span>
                        <span class="label translated">                           
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 16.5 0 8.25 8.25 0 0 1-16.5 0Zm18.528 2.222a.75.75 0 0 0-1.06 1.06l1.22 1.22a.75.75 0 0 0 1.06-1.06l-1.22-1.22Z" clip-rule="evenodd" /><path d="M11.25 17.25a.75.75 0 0 0-.75.75v2.25a.75.75 0 0 0 1.5 0V18a.75.75 0 0 0-.75-.75Z" /></svg>
                            Translated Query: ${translatedQuery}
                        </span>
                        ${isVoiceConversation ? '<span class="voice-conversation-badge"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.25 4.5a3.75 3.75 0 1 1 7.5 0v4a3.75 3.75 0 1 1-7.5 0v-4Z" /><path d="M6 10.5a.75.75 0 0 1 .75.75v1.5a5.25 5.25 0 1 0 10.5 0v-1.5a.75.75 0 0 1 1.5 0v1.5a6.751 6.751 0 0 1-6 6.709v2.291h3a.75.75 0 0 1 0 1.5h-7.5a.75.75 0 0 1 0-1.5h3v-2.291A6.751 6.751 0 0 1 5.25 12.75v-1.5A.75.75 0 0 1 6 10.5Z" /></svg>Voice</span>' : ''}
                    </div>
                    <div class="chat-bubble">
                        <div style="text-align: justify; line-height: 1.6;" class="formatted-content">${formatTextToHTML(reply)}</div>
                    </div>
                </div>
            </div>
        `);
        
        // Automatically speak the AI response if conversation was initiated by voice
        if (typeof speakAIResponse === 'function') {
            // Add slight delay to ensure message is rendered and notification sound plays
            setTimeout(() => {
                speakAIResponse(reply, detectedLang);
            }, 500);
        }
    }

    function addDelayAnimation(){
        $('.chat-area').append(`
         <div class="chat-message fourdot">
                <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.061-1.061l-1.59 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM12 1.5a.75.75 0 0 0-.75.75V3a.75.75 0 0 0 1.5 0V2.25a.75.75 0 0 0-.75-.75ZM6.166 18.894a.75.75 0 0 0 1.061 1.06l1.59-1.59a.75.75 0 0 0-1.06-1.061l-1.591 1.59ZM18.894 17.832a.75.75 0 0 1 0 1.062l-1.59 1.59a.75.75 0 0 1-1.061-1.06l1.59-1.59a.75.75 0 0 1 1.062 0ZM12 22.5a.75.75 0 0 0 .75-.75v-2.25a.75.75 0 0 0-1.5 0v2.25c0 .414.336.75.75.75ZM22.5 12a.75.75 0 0 0-.75-.75h-2.25a.75.75 0 0 0 0 1.5h2.25c.414 0 .75-.336.75-.75ZM1.5 12a.75.75 0 0 0 .75.75h2.25a.75.75 0 0 0 0-1.5H2.25c-.414 0-.75.336-.75.75ZM17.832 6.166a.75.75 0 0 1 1.062 0l1.59 1.59a.75.75 0 1 1-1.06 1.061l-1.59-1.59a.75.75 0 0 1 0-1.061ZM6.166 5.105a.75.75 0 0 1 1.06-1.06l1.59 1.59a.75.75 0 0 1-1.06 1.061l-1.591-1.59Z" /></svg>
                </div>
                <div class="message-content">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        `);
        
        new Audio('assets/audio/message send.mp3').play();
    }

  

         function removeDelayAnimation() {
            $('.chat-area .fourdot').remove();
            new Audio('assets/audio/message-notification.mp3').play();
        }





    function appendErrorMessage(message = "Error: Could not connect to server.") {
                removeDelayAnimation();

        $(".chat-area").append(`
            <div class="chat-message">
                <div class="icon-wrapper">
                                                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.061-1.061l-1.59 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM12 1.5a.75.75 0 0 0-.75.75V3a.75.75 0 0 0 1.5 0V2.25a.75.75 0 0 0-.75-.75ZM6.166 18.894a.75.75 0 0 0 1.061 1.06l1.59-1.59a.75.75 0 0 0-1.06-1.061l-1.591 1.59ZM18.894 17.832a.75.75 0 0 1 0 1.062l-1.59 1.59a.75.75 0 0 1-1.061-1.06l1.59-1.59a.75.75 0 0 1 1.062 0ZM12 22.5a.75.75 0 0 0 .75-.75v-2.25a.75.75 0 0 0-1.5 0v2.25c0 .414.336.75.75.75ZM22.5 12a.75.75 0 0 0-.75-.75h-2.25a.75.75 0 0 0 0 1.5h2.25c.414 0 .75-.336.75-.75ZM1.5 12a.75.75 0 0 0 .75.75h2.25a.75.75 0 0 0 0-1.5H2.25c-.414 0-.75.336-.75.75ZM17.832 6.166a.75.75 0 0 1 1.062 0l1.59 1.59a.75.75 0 1 1-1.06 1.061l-1.59-1.59a.75.75 0 0 1 0-1.061ZM6.166 5.105a.75.75 0 0 1 1.06-1.06l1.59 1.59a.75.75 0 0 1-1.06 1.061l-1.591-1.59Z" /></svg>

                </div>
                <div class="message-content">
                    <div class="chat-bubble">
                        <p style="text-align: justify;">${message}</p>
                    </div>
                </div>
            </div>
        `);
    }

    // Press Enter to send message
    $('#prompt').on('keydown', function(e) {
        if (flag === 1 && (e.key === 'Enter' || e.keyCode === 13)) {
            e.preventDefault();
            const promptText = getPromptText();
            if (promptText.length > 1) {
                $('#sendBtn').click();
            }
        }
    });

    $('#sendBtn').click(async function() {
        const promptText = getPromptText();
        if (promptText.length <= 1) return;

        clearPrompt();
        setButtonsDisabled(true);
        flag = 0;

        appendUserMessage(promptText);
        addDelayAnimation();

        try {
            console.log('üöÄ Sending message:', promptText);
            const API_BASE = (window.ROOTSOURCE_API_BASE || '').replace(/\/$/, '');
            
            // Intelligent endpoint selection with fallback handling
            const hasLocation = userLocation && nasaDataEnabled;
            const endpoint = hasLocation ? '/chat/enhanced' : '/chat';
            const url = `${API_BASE}${endpoint}`;
            
            // Show data source indicator
            const dataSource = hasLocation ? 
                `üõ∞Ô∏è NASA-Enhanced (${userLocation.city}, ${userLocation.country})` : 
                'ü§ñ AI-Enhanced (Advanced Research Mode)';
            console.log('üì° API URL:', url, `- ${dataSource}`);
            
            // Add temporary status indicator
            const statusIndicator = document.createElement('div');
            statusIndicator.className = 'processing-indicator';
            statusIndicator.innerHTML = `
                <div style="padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 8px; margin: 8px 0; font-size: 0.9em; color: #3498db;">
                    <i class="fa fa-spinner fa-spin"></i> Processing with ${dataSource}...
                </div>`;
            document.getElementById('chatbox').appendChild(statusIndicator);
            
            const requestBody = { 
                message: promptText,
                voice: isVoice === 1 
            };
            
            // Add location data if available for NASA-enhanced responses
            if (hasLocation) {
                requestBody.location = {
                    latitude: userLocation.latitude,
                    longitude: userLocation.longitude,
                    city: userLocation.city || null,
                    country: userLocation.country || null
                };
                console.log('üõ∞Ô∏è Including NASA location context in request');
            } else {
                console.log('ü§ñ Using AI-enhanced research mode (NASA data unavailable)');
            }
            
            const response = await fetch(url, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(requestBody)
            });
            
            console.log('üìä Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('‚úÖ Response received:', data.detectedLang || 'unknown language');
            
            // Remove processing indicator
            const existingIndicator = document.querySelector('.processing-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Log data source usage
            if (hasLocation && data.nasa_context_used !== false) {
                console.log('üõ∞Ô∏è Response enhanced with NASA agricultural data!');
            } else {
                console.log('ü§ñ Response generated using AI-enhanced research mode');
            }
            
            appendBotMessage(data.reply, data.detectedLang, data.translatedQuery);
            
        } catch (err) {
            console.error("Error:", err);
            
            // Remove processing indicator on error
            const errorIndicator = document.querySelector('.processing-indicator');
            if (errorIndicator) {
                errorIndicator.remove();
            }
            
            appendErrorMessage();
            setButtonsDisabled(false);
            flag = 1;
        } finally {
            // Ensure cleanup
            const finalIndicator = document.querySelector('.processing-indicator');
            if (finalIndicator) {
                finalIndicator.remove();
            }
            setButtonsDisabled(false);
            flag = 1;
        }
    });
});
</script>

</body>
</html>

